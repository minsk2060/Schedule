############################   HEADERS   ############################################

sauter_cookie = {"JSESSIONID": "b3euu8eyg51qpidr6w6qlg5b",
                 "pw": "73F0CF35AF3850221A1D641803815D686EC21A9316F6CFBFF079AE3B9BFE8DEA",
                 "BAYEUX_BROWSER": "d4f7-wxmcjfmvlu0slpxijixj162f",
                 "uid": "0"}
header ={
        "Accept": "application/json, text/javascript, */*; q=0.01",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "en-GB,en;q=0.9,en-US;q=0.8",
        "Connection": "keep-alive",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.42",
        "X-Requested-With": "XMLHttpRequest"
        }


header_alarm_A={
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
    "Accept-Encoding": "gzip, deflate",
    "Accept-Language": "en-GB,en;q=0.9,en-US;q=0.8",
    "Connection": "keep-alive",
    "Host": "192.168.250.50",
    "Upgrade-Insecure-Requests": "1",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57",
                }



#################################   PLANTS    ###################################

plant = {
        '79691777&did=33555432': 'ПВ-1.1 ',
        '79691782&did=33556432': 'ПВ-2.1 ',
        '8388619&did=33560432':  'ПВ-1.2 ',
        '8388864&did=33557432':  'ПВ-1.5 ',
        '8388871&did=33557432':  'ПВ-1.6 ',
        '8388858&did=33557432':  'ПВ-1.7 ',
        '8388708&did=33557432':  'П-1.8  ',
        '8388676&did=33559432':  'П-1.9  ',
        '8388704&did=33557432':  'П-1.10 ',
        '8388743&did=33559432':  'П-1.11 ',
        '8388762&did=33560432':  'ПВ-2.2 ',
        '8388822&did=33561432':  'ПВ-2.3 ',
        '8388808&did=33561432':  'ПВ-2.4 ',
        '8388778&did=33560432':  'ПВ-2.5 ',
        '8388770&did=33560432':  'ПВ-2.6 ',
        '8388827&did=33561432':  'ПВ-2.7 ',
        '8388835&did=33561432':  'ПВ-2.8 ',
        '8388815&did=33561432':  'ПВ-2.9 ',
        '8388788&did=33560432':  'ПВ-2.10',
        '8388739&did=33559432':  'ПВ-2.11',
        '8388750&did=33559432':  'ПВ-2.12',
        '8388757&did=33559432':  'ПВ-2.13',
        '8388795&did=33560432':  'ПВ-2.14',
        '8388845&did=33559432':  'ПВ-2.15',
        '8388650&did=33561432':  'П-2.18 ',
        '8388672&did=33559432':  'П-2.19 ',
        '8388654&did=33561432':  'П-2.20 ',
        '8388614&did=33560432':  'П-2.21 ',
        '8388902&did=33560432':  'П-2.23 ',
        '8388851&did=33559432':  'П-2.24 ',
        '79992777&did=33554453': 'В-1.9  ',
        '79993777&did=33554453': 'B-1.38 ',
        '8388883&did=33560432':  'Бассейн'
        }

alarms_A={
        #'20971538&did=33555432':  'ПВ-1.1 ',
        # '79691782&did=33556432':  'ПВ-2.1 ',
        '12582981&did=33560432':  'ПВ-1.2 ',
        '12584064&did=33557432':  'ПВ-1.5 ',
        '12584092&did=33557432':  'ПВ-1.6 ',
        '12584036&did=33557432':  'ПВ-1.7 ',
        '12583436&did=33557432':  'П-1.8  ',
        '12583282&did=33559432':  'П-1.9  ',
        '12583415&did=33557432':  'П-1.10 ',
        '12583596&did=33559432':  'П-1.11 ',
        '12583680&did=33560432':  'ПВ-2.2 ',
        '12583904&did=33561432':  'ПВ-2.3 ',
        '12583848&did=33561432':  'ПВ-2.4 ',
        '12583736&did=33560432':  'ПВ-2.5 ',
        '12583708&did=33560432':  'ПВ-2.6 ',
        '12583960&did=33561432':  'ПВ-2.7 ',
        '12583932&did=33561432':  'ПВ-2.8 ',
        '12583876&did=33561432':  'ПВ-2.9 ',
        '12583764&did=33560432':  'ПВ-2.10',
        '12583575&did=33559432':  'ПВ-2.11',
        '12583624&did=33559432':  'ПВ-2.12',
        '12583652&did=33559432':  'ПВ-2.13',
        '12583792&did=33560432':  'ПВ-2.14',
        '12583988&did=33559432':  'ПВ-2.15',
        '12583142&did=33561432':  'П-2.18 ',
        '12583261&did=33559432':  'П-2.19 ',
        #'12583163&did=33561432':  'П-2.20 ',
        '12582953&did=33560432':  'П-2.21 ',
        # '8388902&did=33560432':   'П-2.23 ',
        '12584008&did=33559432':  'П-2.24 ',
        # # '21272522&did=33554453&vid=80': 'В-1.9.1  ',
        # '7d9992777&did=33554453':       'В-1.9.2  ',
        # '21273522&did=33554453&vid=80': 'B-1.38.1 ',
        # '21273527&did=33554453&vid=80': 'B-1.38.2 ',
        # '8388883&did=33560432':         'Бассейн'
        }

alarms_BC={
        #'20971538&did=33555432': 'ПВ-1.1 ',
        # '79691782&did=33556432': 'ПВ-2.1 ',
        '12582982&did=33560432':  'ПВ-1.2 ',
        '12584065&did=33557432':  'ПВ-1.5 ',
        "12584093&did=33557432":  'ПВ-1.6 ',
        '12584037&did=33557432':  'ПВ-1.7 ',
        '12583437&did=33557432':  'П-1.8  ',
        '12583283&did=33559432':  'П-1.9  ',
        '12583416&did=33557432':  'П-1.10 ',
        '12583597&did=33559432':  'П-1.11 ',
        '12583681&did=33560432':  'ПВ-2.2 ',
        '12583905&did=33561432':  'ПВ-2.3 ',
        '12583849&did=33561432':  'ПВ-2.4 ',
        '12583737&did=33560432':  'ПВ-2.5 ',
        '12583709&did=33560432':  'ПВ-2.6 ',
        '12583961&did=33561432':  'ПВ-2.7 ',
        '12583933&did=33561432':  'ПВ-2.8 ',
        '12583877&did=33561432':  'ПВ-2.9 ',
        '12583765&did=33560432':  'ПВ-2.10',
        '12583576&did=33559432':  'ПВ-2.11',
        '12583625&did=33559432':  'ПВ-2.12',
        '12583653&did=33559432':  'ПВ-2.13',
        '12583793&did=33560432':  'ПВ-2.14',
        '12583989&did=33559432':  'ПВ-2.15',
        '12583143&did=33561432':  'П-2.18 ',
        '12583262&did=33559432':  'П-2.19 ',
        #'12583164&did=33561432':  'П-2.20 ',
        '12582954&did=33560432':  'П-2.21 ',
        # '8388902&did=33560432':  'П-2.23 ',
        '12584009&did=33559432':  'П-2.24 ',
        # '79992777&did=33554453': 'В-1.9  ',
        # '79993777&did=33554453': 'B-1.38 ',
        # '8388883&did=33560432':  'Бассейн'
        }


driers = ["79691782&did=33556432", "79691777&did=33555432"]
swpool = ["8388883&did=33560432",]



##########################   TELEGRAMTOKEN   ####################################

telegramtoken = "6182428747:AAF9uTc4GsJ_TpB3p-dNwq0hwrMEwF4Bm5Y"

telegram_users = {"Mikhail": "1140621075",
                  "Michael":  "5740110040",
                  "Roman":    "1565146153",
                  "Alexandr": "981504594",
                  "Nikita":   "397472880",
                  "Andrey":   "2116310630",
                  "Yury":     "1969627530",
                  "Euheny":   "1016661717",
                }

#########################   TELEGRAMBOTALARMS   #################################

import telebot

bot = telebot.TeleBot(telegramtoken)


def to_telegram(msg):
    bot = telebot.TeleBot(telegramtoken)
    for i in telegram_users.values():
        bot.send_message(i, msg)

####################################     VIBERTOKEN   #############################################
vibertoken = "5140698d1667e793-1e3d51e47aac03f2-dafdbd02d7d47bec"
viberavatar = "C:/Users/BMS/projects/schedules/logo.jpg"
viberbotname = "Вентиляция ФСК"
viberwebhook = "https://d60d-37-45-171-18.ngrok-free.app"


viber_users = {"Mikhail":  "EqHRh78MtyO9Ndjbr7BAkg==",
               "Michael":  "FBNFWql3KAXMAlnre7BdPg==",
               "Vladimir": "T4Zhj4CMqhfVeU+7Kj3c4g==",
               "Artur":    "P9KspqPKHWrndDaDHHigpQ=="}



import datetime
from pywinauto.application import Application


class Textjob:
    pathcur = "./logging/log_scheduling.txt"
    pathall = "./logging/alllogs.txt"
    readlog = "./logging/readlogs.txt"
    def __init__(self, path, flag):
        self.path = path
        self.flag = flag
    def makelog(self, data, n=""):
        f = open(self.path, self.flag)
        f.write("".join(data) + n)
        f.close()


def log(plantcode, acting):
    close()
    logwrite = [datetime.datetime.now().strftime("%d-%m-%Y  %H:%M  "), plant[f"{plantcode}"], act(plantcode, acting)]
    l = Textjob(Textjob.pathall, "a")
    l.makelog(logwrite, "\n")
    sort()


def close():
    ntp = Application()
    try:
        ntp.connect(title_re="log_scheduling")
        ntp.window().close()
    except:
        pass


def act (singlecode, whattodo):
    action = ""
    a = whattodo[-1:]
    if   a == "1": action = "  Пуск на низкой скорости"
    elif a == "2": action = "  Пуск на высокой скорости"
    elif a == "0": action = "  Cтоп"
    # If swimming pool
    if singlecode in swpool:
        if   a == "0": action = "  Выключение подсветки"
        elif a == "2": action = "  Включение желтой подсветки"
        elif a == "1": action = "  Включение синей подсветки"
    elif singlecode in driers:
        if   a == "5": action = "  Стоп"
        elif a == "1": action = "  Пуск в режиме хоккей"
        elif a == "2": action = "  Пуск в режиме фигурное катание"
    return action


def writelog(parttasks, partlogs):
    logtasks=[]
    alllogs =[]
    for c in range(len(parttasks)):
        if c >= 1 :
            if abs(int(parttasks[c][0:2])-int(parttasks[c-1][0:2])) >= 1:
               logtasks.append('\n')
        logtasks.append(f'{"".join(parttasks[c])}\n')
    for c in range(len(partlogs)):
        alllogs.append(f'{"".join(partlogs[c])}\n')
    f = Textjob(Textjob.pathcur, "w")
    d = Textjob(Textjob.pathall, "w")
    d.makelog(alllogs)
    f.makelog(logtasks)


def sort():
    f = open(Textjob.pathall, "r")
    current = f.read().split("\n")
    parttasks = []
    partlogs  = []
    rightnow = datetime.datetime.now()
    for i in range(len(current)-1):
        logtime = datetime.datetime.strptime(current[i][0:16], "%d-%m-%Y  %H:%M")
        if rightnow - datetime.timedelta(days=1) <= logtime:
            parttasks.append(current[i])
        if rightnow - datetime.timedelta(days=10) < logtime:
            partlogs.append(current[i])
    f.close()
    writelog(parttasks, partlogs)


days={   "sunday": "Воскресенье",
         "monday": "Понедельник",
        "tuesday": "Вторник    ",
      "wednesday": "Среда      ",
       "thursday": "Четверг    ",
         "friday": "Пятница    ",
       "saturday": "Суббота    "}


def readlogs(logs_read):
    reads = []
    ttdys = []
    today = datetime.datetime.now().date()
    yrday = today - datetime.timedelta(days=1)
    tmday = today + datetime.timedelta(days=1)
    str_today = today.strftime("%A").lower()
    str_tmday = tmday.strftime("%A").lower()
    for i in logs_read:
        if i[1] == str_today  or i[1] == str_tmday:
            ttdys.append(i)
    for i in ttdys:
        reads.append(f"{plant[i[0]]}   {''.join(days[i[1]])}   {''.join(i[2][0:5])} {(act(i[0], i[3]))} \n")
    t = Textjob(Textjob.readlog, "w")
    t.makelog(reads)



##########################################   EXCELS    ################################################

from openpyxl import load_workbook

schedule_book = "./excel/Расписание.xlsm"
status_book   = "./excel/Cостояние.xlsx"
single = []


def refresh(tasks):
    tasks.append(single.copy())
    single.clear()

 
def refreeze(row, lis, book):
    plancod = (str(book.active.cell(row=row, column=4).value))
    lis.append(plancod)
    return plancod


def drier(row, lis, book):
    dry = str(book.active.cell(row=row, column=4).value)
    if dry in driers:
        lis.append("5")
    else:
        lis.append("0")


def readschedule(tasks):
    workbook = load_workbook(schedule_book)
    for j in range(53, 383, 10):
        for k in range(1, 8):
            refreeze(j, single, workbook)
            for s in [2, 5, 3]:
                single.append(str(workbook.active.cell(row=j + k, column=s).value))
            refresh(tasks)
            refreeze(j, single, workbook)
            for s in [2, 6]:
                single.append(str(workbook.active.cell(row=j + k, column=s).value))
            drier(j, single, workbook)
            refresh(tasks)
            refreeze(j, single, workbook)
            for s in [2, 8, 10]:
                single.append(str(workbook.active.cell(row=j + k, column=s).value))
            refresh(tasks)
            refreeze(j, single, workbook)
            for s in [2, 9]:
                single.append(str(workbook.active.cell(row=j + k, column=s).value))
            drier(j, single, workbook)
            refresh(tasks)
    return tasks


def writestatus(i, plant, alarm, column):
    statusbook = load_workbook(status_book)
    date_now = datetime.datetime.now().strftime("%d-%m-%Y")
    time_now = datetime.datetime.now().strftime("%H:%M")
    statusbook.active.cell(row=3+i, column=1).value = date_now
    statusbook.active.cell(row=3+i, column=2).value = time_now
    statusbook.active.cell(row=3+i, column=3).value = plant
    if statusbook.active.cell(row=3+i, column=column).value != alarm:
        alarm_happen = [f"{date_now}  ", f"{time_now}  ", f"{plant}  ",  alarm]
        m = Textjob(Textjob.pathall, "a")
        m.makelog(alarm_happen, "\n")
        sort()
        logmsg = "\n".join(alarm_happen[2:])
        to_telegram(logmsg)
        # to_viber(logmsg)
    statusbook.active.cell(row=3 + i, column=column).value = alarm
    statusbook.save(status_book)


##########################################     REQESTS     #############################################

import time
import requests

def switch(get_plant, par):
    url = f"http://192.168.250.50/ajaxjson/bac/setValue?pid=85&oid={get_plant}{par}"
    r = requests.get(url, headers=header, cookies=sauter_cookie)


def getalarms(alarms_dict, column_number, alarm_text):
    for i, j in enumerate(alarms_dict.keys()):
        time.sleep(10)
        url=f"http://192.168.250.50/svo/details/update?oid={j}&vid=17&mode=cached"
        r=requests.get(url, headers=header_alarm_A, cookies=sauter_cookie, allow_redirects=False)
        alarms_now = "Авария снята"
        if r.text:
            if "Alarm: true" in r.text:
                if 'title="Fault: true"' not in r.text:
                    alarms_now = alarm_text
        writestatus(i, alarms_dict[j], alarms_now, column_number)



################################         SCHEDULE         ########################################
import schedule
import time


print("РАБОТАЕТ УПРАВЛЕНИЕ ОБОРУДОВАНИЕМ ПО РАСПИСАНИЮ, НЕ ЗАКРЫВАЙТЕ ЭТО ОКНО")

tasks = []


def turn(get_plant, par):
    log(get_plant, par)
    switch(get_plant, par)


def runschedule():
    clearlogs = readschedule(tasks)
    cleartasks = clearlogs.copy()
    for t in range(len(tasks)):
        if tasks[t][2] == "None":
            cleartasks.remove(tasks[t])
    schedule.clear('cleared')
    for i in range(len(cleartasks)):
        exec(f"schedule.every().{cleartasks[i][1]}"
             f".at('{cleartasks[i][2]}')"
             f".do(turn,'{cleartasks[i][0]}','&vid=17&value={cleartasks[i][3]}')"
             f".tag('cleared')")
    readlogs(cleartasks)
    cleartasks.clear()
    tasks.clear()


schedule.every(2).minutes.do(runschedule)
schedule.every(13).minutes.do(getalarms, alarms_dict=alarms_A,  column_number=4, alarm_text='Авария класса А')
schedule.every(23).minutes.do(getalarms, alarms_dict=alarms_BC, column_number=5, alarm_text='Авария класса B,C')


while True:
    schedule.run_pending()
    time.sleep(1)

#############################################
